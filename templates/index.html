<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>èªéŸ³è½‰éŒ„è©•ä¼°ç³»çµ±</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      :root {
        --primary-gradient: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        --secondary-gradient: linear-gradient(135deg, #00cec9 0%, #55a3ff 100%);
        --success-gradient: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #e84393 100%);
        --danger-gradient: linear-gradient(135deg, #e84393 0%, #fd79a8 100%);
        --bg-gradient: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        --glass-bg: rgba(0, 212, 170, 0.08);
        --glass-border: rgba(0, 212, 170, 0.15);
        --shadow-light: 0 8px 32px rgba(0, 212, 170, 0.1);
        --shadow-medium: 0 12px 40px rgba(0, 212, 170, 0.15);
        --shadow-heavy: 0 20px 60px rgba(0, 212, 170, 0.2);
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --text-light: rgba(255, 255, 255, 0.9);
        --text-dim: rgba(255, 255, 255, 0.7);
        --accent-green: #00d4aa;
        --accent-cyan: #00cec9;
        --border-radius: 16px;
        --border-radius-sm: 8px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* èƒŒæ™¯å‹•ç•« */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(0, 212, 170, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(0, 206, 201, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 40%,
            rgba(85, 163, 255, 0.08) 0%,
            transparent 50%
          );
        animation: float 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        33% {
          transform: translateY(-20px) rotate(1deg);
        }
        66% {
          transform: translateY(10px) rotate(-1deg);
        }
      }

      .container {
        max-width: 420px;
        margin: 0 auto;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        min-height: 100vh;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(0, 212, 170, 0.1);
      }

      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 212, 170, 0.05) 0%,
          rgba(0, 184, 148, 0.02) 100%
        );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.15) 0%,
          rgba(0, 206, 201, 0.1) 100%
        );
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--glass-border);
        color: var(--text-light);
        padding: 30px 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(0, 212, 170, 0.1) 0%,
          transparent 70%
        );
        animation: headerGlow 8s ease-in-out infinite;
      }

      @keyframes headerGlow {
        0%,
        100% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(180deg);
        }
      }

      .header-content {
        position: relative;
        z-index: 1;
      }

      .header h1 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 20px rgba(0, 212, 170, 0.3);
        background: linear-gradient(
          135deg,
          var(--accent-green),
          var(--accent-cyan)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header .subtitle {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 400;
        color: var(--text-dim);
      }

      .main-content {
        padding: 25px 20px;
        position: relative;
        z-index: 1;
      }

      /* æ¨¡å¼åˆ‡æ›å™¨ */
      .input-mode-switcher {
        display: flex;
        background: rgba(0, 212, 170, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius);
        padding: 6px;
        margin-bottom: 25px;
        box-shadow: var(--shadow-light);
      }

      .mode-button {
        flex: 1;
        padding: 12px 16px;
        border: none;
        border-radius: var(--border-radius-sm);
        background: transparent;
        color: var(--text-dim);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .mode-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.1) 0%,
          rgba(0, 206, 201, 0.05) 100%
        );
        opacity: 0;
        transition: var(--transition);
      }

      .mode-button:hover::before {
        opacity: 1;
      }

      .mode-button.active {
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.2) 0%,
          rgba(0, 206, 201, 0.15) 100%
        );
        color: var(--accent-green);
        box-shadow: 0 4px 20px rgba(0, 212, 170, 0.2);
        transform: translateY(-1px);
      }

      /* æ¨™æº–æ–‡æœ¬è¼¸å…¥å€åŸŸ */
      .reference-section {
        background: rgba(0, 212, 170, 0.05);
        backdrop-filter: blur(15px);
        border: 2px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        transition: var(--transition);
      }

      .reference-section.ready {
        border-color: rgba(0, 212, 170, 0.3);
        background: rgba(0, 212, 170, 0.08);
        box-shadow: 0 0 30px rgba(0, 212, 170, 0.15);
      }

      .reference-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .reference-title::before {
        content: "ğŸ“„";
        font-size: 18px;
      }

      .reference-textarea {
        width: 100%;
        background: rgba(0, 212, 170, 0.03);
        border: 1px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius-sm);
        padding: 12px 15px;
        color: var(--text-light);
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        min-height: 80px;
        transition: var(--transition);
      }

      .reference-textarea:focus {
        outline: none;
        border-color: rgba(0, 212, 170, 0.3);
        background: rgba(0, 212, 170, 0.05);
        box-shadow: 0 0 20px rgba(0, 212, 170, 0.1);
      }

      .reference-textarea::placeholder {
        color: var(--text-dim);
      }

      .reference-hint {
        font-size: 12px;
        color: var(--text-dim);
        margin-top: 8px;
        line-height: 1.4;
      }

      /* è¼¸å…¥å€åŸŸ */
      .input-section {
        background: rgba(0, 212, 170, 0.05);
        backdrop-filter: blur(15px);
        border: 2px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius);
        padding: 35px 25px;
        text-align: center;
        margin-bottom: 25px;
        min-height: 280px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .input-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(0, 212, 170, 0.05) 50%,
          transparent 70%
        );
        transform: translateX(-100%);
        transition: transform 0.6s ease;
      }

      .input-section:hover::before {
        transform: translateX(100%);
      }

      .input-section.ready {
        border-color: rgba(0, 212, 170, 0.3);
        background: rgba(0, 212, 170, 0.08);
        box-shadow: 0 0 30px rgba(0, 212, 170, 0.15);
      }

      .input-section.active {
        border-color: rgba(0, 184, 148, 0.4);
        background: rgba(0, 184, 148, 0.1);
        box-shadow: 0 0 30px rgba(0, 184, 148, 0.2);
        animation: activePulse 2s ease-in-out infinite;
      }

      @keyframes activePulse {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(0, 184, 148, 0.2);
        }
        50% {
          box-shadow: 0 0 50px rgba(0, 184, 148, 0.3);
        }
      }

      .input-section.processing {
        border-color: rgba(0, 206, 201, 0.4);
        background: rgba(0, 206, 201, 0.08);
        box-shadow: 0 0 30px rgba(0, 206, 201, 0.2);
      }

      .input-section.completed {
        border-color: rgba(0, 212, 170, 0.5);
        background: rgba(0, 212, 170, 0.1);
        box-shadow: 0 0 30px rgba(0, 212, 170, 0.25);
      }

      /* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
      .upload-content,
      .file-selected,
      .recording-content {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1;
      }

      .upload-content.active,
      .file-selected.active,
      .recording-content.active {
        display: flex;
      }

      .upload-text {
        font-size: 22px;
        color: var(--text-light);
        margin-bottom: 8px;
        font-weight: 600;
        text-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
      }

      .upload-hint {
        font-size: 13px;
        color: var(--text-dim);
        margin-bottom: 25px;
        line-height: 1.5;
        max-width: 280px;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.15) 0%,
          rgba(0, 206, 201, 0.1) 100%
        );
        border: 1px solid rgba(0, 212, 170, 0.2);
        color: var(--accent-green);
        padding: 12px 24px;
        border-radius: var(--border-radius-sm);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        margin-bottom: 25px;
      }

      .upload-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 212, 170, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 170, 0.2);
        border-color: rgba(0, 212, 170, 0.3);
      }

      .upload-btn:hover::before {
        left: 100%;
      }

      /* æª”æ¡ˆè³‡è¨Šå¡ç‰‡ */
      .file-info {
        background: rgba(0, 212, 170, 0.08);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(0, 212, 170, 0.15);
        border-radius: var(--border-radius-sm);
        padding: 16px 20px;
        margin-bottom: 20px;
        min-width: 220px;
        box-shadow: var(--shadow-medium);
      }

      .file-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 5px;
        word-break: break-all;
      }

      .file-size {
        font-size: 13px;
        color: var(--text-dim);
      }

      .file-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .file-action-btn {
        padding: 10px 18px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      .change-file {
        background: rgba(0, 206, 201, 0.15);
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 206, 201, 0.2);
      }

      .remove-file {
        background: rgba(232, 67, 147, 0.15);
        color: #e84393;
        border: 1px solid rgba(232, 67, 147, 0.2);
      }

      .file-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.1);
      }

      /* éŒ„éŸ³æ¨£å¼ */
      .recording-status {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-light);
        min-height: 22px;
        text-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
      }

      .record-button {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid rgba(0, 212, 170, 0.3);
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.2) 0%,
          rgba(0, 184, 148, 0.15) 100%
        );
        color: var(--accent-green);
        font-size: 28px;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 30px rgba(0, 212, 170, 0.2);
        position: relative;
        overflow: hidden;
      }

      .record-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle,
          rgba(0, 212, 170, 0.1) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: var(--transition);
      }

      .record-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 12px 40px rgba(0, 212, 170, 0.3);
        border-color: rgba(0, 212, 170, 0.5);
      }

      .record-button:hover:not(:disabled)::before {
        opacity: 1;
      }

      .record-button:disabled {
        background: rgba(160, 160, 160, 0.1);
        color: var(--text-secondary);
        cursor: not-allowed;
        box-shadow: none;
        border-color: rgba(160, 160, 160, 0.2);
      }

      .record-button.recording {
        background: linear-gradient(
          135deg,
          rgba(0, 184, 148, 0.3) 0%,
          rgba(0, 212, 170, 0.2) 100%
        );
        animation: recordingPulse 1.5s ease-in-out infinite;
        box-shadow: 0 8px 30px rgba(0, 184, 148, 0.3);
        border-color: rgba(0, 184, 148, 0.5);
      }

      @keyframes recordingPulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 8px 30px rgba(0, 184, 148, 0.3);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 12px 40px rgba(0, 184, 148, 0.4);
        }
      }

      .recording-timer {
        font-size: 24px;
        font-weight: 700;
        color: var(--accent-green);
        margin-bottom: 15px;
        font-family: "Courier New", monospace;
        min-height: 30px;
        text-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
      }

      .recording-hint {
        font-size: 13px;
        color: var(--text-dim);
        line-height: 1.4;
        min-height: 18px;
      }

      /* è™•ç†æ­¥é©Ÿ */
      .process-steps {
        margin: 25px 0;
        position: relative;
      }

      .step {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 18px;
        margin-bottom: 10px;
        background: rgba(0, 212, 170, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius-sm);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .step::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(0, 212, 170, 0.05) 50%,
          transparent 70%
        );
        transform: translateX(-100%);
        transition: transform 0.6s ease;
      }

      .step.processing::before {
        transform: translateX(100%);
        animation: stepShine 2s ease-in-out infinite;
      }

      @keyframes stepShine {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .step.waiting {
        border-color: rgba(0, 212, 170, 0.1);
        background: rgba(0, 212, 170, 0.02);
      }

      .step.ready {
        border-color: rgba(0, 212, 170, 0.3);
        background: rgba(0, 212, 170, 0.08);
        box-shadow: 0 4px 20px rgba(0, 212, 170, 0.1);
      }

      .step.processing {
        border-color: rgba(0, 206, 201, 0.4);
        background: rgba(0, 206, 201, 0.1);
        box-shadow: 0 4px 20px rgba(0, 206, 201, 0.15);
        animation: stepGlow 2s ease-in-out infinite;
      }

      @keyframes stepGlow {
        0%,
        100% {
          box-shadow: 0 4px 20px rgba(0, 206, 201, 0.15);
        }
        50% {
          box-shadow: 0 8px 30px rgba(0, 206, 201, 0.25);
        }
      }

      .step.completed {
        border-color: rgba(0, 184, 148, 0.4);
        background: rgba(0, 184, 148, 0.1);
        box-shadow: 0 4px 20px rgba(0, 184, 148, 0.15);
      }

      .step-left {
        display: flex;
        align-items: center;
        flex: 1;
      }

      .step-icon {
        font-size: 20px;
        margin-right: 12px;
        width: 24px;
        text-align: center;
        filter: drop-shadow(0 2px 8px rgba(0, 212, 170, 0.2));
        color: var(--accent-green);
      }

      .step-text {
        font-size: 15px;
        font-weight: 500;
        color: var(--text-light);
      }

      .step-status {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 15px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        transition: var(--transition);
      }

      .step-status.waiting {
        background: rgba(0, 212, 170, 0.05);
        color: var(--text-dim);
        border: 1px solid rgba(0, 212, 170, 0.1);
      }

      .step-status.ready {
        background: rgba(0, 212, 170, 0.15);
        color: var(--accent-green);
        border: 1px solid rgba(0, 212, 170, 0.2);
      }

      .step-status.processing {
        background: rgba(0, 206, 201, 0.15);
        color: var(--accent-cyan);
        border: 1px solid rgba(0, 206, 201, 0.2);
      }

      .step-status.completed {
        background: rgba(0, 184, 148, 0.15);
        color: var(--accent-green);
        border: 1px solid rgba(0, 184, 148, 0.2);
      }

      .step-status.clickable {
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .step-status.clickable::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 212, 170, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      .step-status.clickable:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.15);
      }

      .step-status.clickable:hover::before {
        left: 100%;
      }

      .step-status.clickable:after {
        content: " â†—";
        font-size: 10px;
        opacity: 0.8;
      }

      /* æ“ä½œæŒ‰éˆ• */
      .action-btn {
        width: 100%;
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.15) 0%,
          rgba(0, 184, 148, 0.1) 100%
        );
        border: 1px solid rgba(0, 212, 170, 0.2);
        color: var(--accent-green);
        padding: 16px 20px;
        border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin: 25px 0 0 0;
        transition: var(--transition);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-medium);
      }

      .action-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 212, 170, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      .action-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(0, 212, 170, 0.2);
        border-color: rgba(0, 212, 170, 0.3);
      }

      .action-btn:hover:not(:disabled)::before {
        left: 100%;
      }

      .action-btn:disabled {
        background: rgba(160, 160, 160, 0.05);
        color: var(--text-secondary);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: rgba(160, 160, 160, 0.1);
      }

      .action-btn.processing {
        background: linear-gradient(
          135deg,
          rgba(0, 206, 201, 0.2) 0%,
          rgba(0, 212, 170, 0.15) 100%
        );
        color: var(--accent-cyan);
        border-color: rgba(0, 206, 201, 0.3);
      }

      /* è¼‰å…¥ç‹€æ…‹ */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(0, 212, 170, 0.2);
        border-top: 2px solid var(--accent-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* å½ˆçª—æ¨£å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        backdrop-filter: blur(20px);
        margin: 10% auto;
        padding: 30px;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-heavy);
        border: 1px solid rgba(0, 212, 170, 0.15);
        position: relative;
        overflow: hidden;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(0, 212, 170, 0.05) 0%,
          rgba(0, 184, 148, 0.02) 100%
        );
        pointer-events: none;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(0, 212, 170, 0.1);
        position: relative;
        z-index: 1;
      }

      .modal-header h3 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        background: linear-gradient(
          135deg,
          var(--accent-green),
          var(--accent-cyan)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .close {
        color: var(--text-secondary);
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 212, 170, 0.05);
        border: 1px solid rgba(0, 212, 170, 0.1);
      }

      .close:hover {
        color: var(--accent-green);
        background: rgba(0, 212, 170, 0.1);
        border-color: rgba(0, 212, 170, 0.2);
      }

      .modal-content-text {
        background: rgba(0, 212, 170, 0.05);
        padding: 20px;
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
        border-left: 4px solid var(--accent-green);
        position: relative;
        z-index: 1;
        border: 1px solid rgba(0, 212, 170, 0.1);
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .error-message {
        background: rgba(232, 67, 147, 0.1);
        border: 1px solid rgba(232, 67, 147, 0.2);
        color: #e84393;
        padding: 15px 20px;
        border-radius: var(--border-radius-sm);
        margin: 20px 0;
        font-size: 14px;
        backdrop-filter: blur(10px);
      }

      .hidden {
        display: none !important;
      }

      /* è©•ä¼°çµæœå¡ç‰‡ */
      .evaluation-result {
        background: rgba(0, 212, 170, 0.05);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(0, 212, 170, 0.1);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin: 20px 0;
        display: none;
      }

      .evaluation-result.show {
        display: block;
        animation: slideInUp 0.5s ease-out;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .metric-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .metric-item {
        background: rgba(0, 212, 170, 0.03);
        border-radius: var(--border-radius-sm);
        padding: 15px;
        text-align: center;
        border: 1px solid rgba(0, 212, 170, 0.08);
        position: relative;
        overflow: hidden;
      }

      .metric-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          135deg,
          var(--accent-green),
          var(--accent-cyan)
        );
      }

      .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--accent-green);
        margin-bottom: 5px;
        text-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
      }

      .metric-label {
        font-size: 12px;
        color: var(--text-dim);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.8px;
      }

      .accuracy-level {
        background: rgba(0, 212, 170, 0.08);
        border: 1px solid rgba(0, 212, 170, 0.15);
        border-radius: var(--border-radius-sm);
        padding: 12px 16px;
        margin-bottom: 20px;
        text-align: center;
      }

      .accuracy-level-title {
        font-size: 14px;
        color: var(--text-dim);
        margin-bottom: 5px;
        font-weight: 500;
      }

      .accuracy-level-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent-green);
        text-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
      }

      .error-analysis {
        background: rgba(0, 212, 170, 0.03);
        border-radius: var(--border-radius-sm);
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid rgba(0, 212, 170, 0.08);
      }

      .error-analysis-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .error-analysis-title::before {
        content: "ğŸ“Š";
        font-size: 16px;
      }

      .error-types {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .error-type {
        background: rgba(0, 212, 170, 0.1);
        border: 1px solid rgba(0, 212, 170, 0.15);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text-light);
        flex: 1;
        min-width: 80px;
        text-align: center;
      }

      .error-type-count {
        display: block;
        font-size: 16px;
        font-weight: 700;
        color: var(--accent-green);
        margin-bottom: 2px;
      }

      .error-type-label {
        font-size: 10px;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .suggestions-section {
        background: rgba(0, 184, 148, 0.05);
        border: 1px solid rgba(0, 184, 148, 0.1);
        border-radius: var(--border-radius-sm);
        padding: 15px;
        border-left: 4px solid var(--accent-green);
      }

      .suggestions-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .suggestions-title::before {
        content: "ğŸ’¡";
        font-size: 16px;
      }

      .suggestions-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .suggestions-list li {
        background: rgba(0, 212, 170, 0.05);
        border: 1px solid rgba(0, 212, 170, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        margin-bottom: 8px;
        font-size: 13px;
        color: var(--text-light);
        line-height: 1.4;
        position: relative;
        padding-left: 24px;
      }

      .suggestions-list li::before {
        content: "â€¢";
        position: absolute;
        left: 12px;
        color: var(--accent-green);
        font-weight: bold;
      }

      .suggestions-list li:last-child {
        margin-bottom: 0;
      }

      /* æµ®å‹•ç²’å­èƒŒæ™¯ */
      .floating-particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        background: rgba(0, 212, 170, 0.1);
        border-radius: 50%;
        animation: float-particle 15s infinite linear;
      }

      @keyframes float-particle {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
          opacity: 0;
        }
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 480px) {
        .container {
          max-width: 100%;
        }

        .main-content {
          padding: 20px 15px;
        }

        .input-section {
          padding: 30px 20px;
          min-height: 280px;
        }

        .record-button {
          width: 90px;
          height: 90px;
          font-size: 24px;
        }

        .upload-text {
          font-size: 18px;
        }

        .modal-content {
          margin: 20% auto;
          padding: 20px;
          width: 95%;
        }

        .metric-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .error-types {
          flex-direction: column;
          gap: 8px;
        }
      }
    </style>
  </head>

  <body>
    <!-- æµ®å‹•ç²’å­èƒŒæ™¯ -->
    <div class="floating-particles" id="particles"></div>

    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>èªéŸ³è½‰éŒ„è©•ä¼°ç³»çµ±</h1>
          <div class="subtitle">èªéŸ³æº–ç¢ºæ€§åˆ†æèˆ‡å“è³ªè©•ä¼°</div>
        </div>
      </div>

      <div class="main-content">
        <!-- è¼¸å…¥æ¨¡å¼åˆ‡æ› -->
        <div class="input-mode-switcher">
          <button class="mode-button active" onclick="switchToUpload()">
            æª”æ¡ˆä¸Šå‚³
          </button>
          <button class="mode-button" onclick="switchToRecording()">
            å³æ™‚éŒ„éŸ³
          </button>
        </div>

        <!-- çµ±ä¸€çš„è¼¸å…¥å€åŸŸ -->
        <div class="input-section" id="inputSection">
          <!-- æª”æ¡ˆä¸Šå‚³å…§å®¹ -->
          <div class="upload-content active" id="uploadContent">
            <input
              type="file"
              id="audioFile"
              class="file-input"
              accept=".mp3,.wav,.m4a,.aac,.ogg,.webm,.flac,.mp4,.avi,.mov"
              onchange="handleFileSelect(event)"
            />
            <div class="upload-text">é¸æ“‡éŸ³é »æª”æ¡ˆ</div>
            <button
              class="upload-btn"
              onclick="document.getElementById('audioFile').click()"
            >
              ç€è¦½æª”æ¡ˆ
            </button>
            <div class="upload-hint">
              æ”¯æ´ MP3ã€WAVã€M4A ç­‰å¤šç¨®éŸ³é »æ ¼å¼<br />æª”æ¡ˆå¤§å°é™åˆ¶ 100MB
            </div>
          </div>

          <!-- æª”æ¡ˆå·²é¸ä¸­ -->
          <div class="file-selected" id="fileSelected">
            <div class="upload-text">æª”æ¡ˆå·²æº–å‚™</div>
            <div class="file-info">
              <div id="fileName" class="file-name"></div>
              <div id="fileSize" class="file-size"></div>
            </div>
            <div class="file-actions">
              <button
                class="file-action-btn change-file"
                onclick="document.getElementById('audioFile').click()"
              >
                æ›´æ›æª”æ¡ˆ
              </button>
              <button
                class="file-action-btn remove-file"
                onclick="removeFile()"
              >
                ç§»é™¤æª”æ¡ˆ
              </button>
            </div>
          </div>

          <!-- éŒ„éŸ³å…§å®¹ -->
          <div class="recording-content" id="recordingContent">
            <button
              class="record-button"
              id="recordButton"
              onclick="toggleRecording()"
            >
              â—
            </button>
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-hint" id="recordingHint">é»æ“Šé–‹å§‹éŒ„éŸ³</div>
          </div>
        </div>

        <!-- æ¨™æº–æ–‡æœ¬è¼¸å…¥å€åŸŸ -->
        <div class="reference-section" id="referenceSection">
          <div class="reference-title">æ¨™æº–åƒè€ƒæ–‡æœ¬</div>
          <textarea
            id="referenceText"
            class="reference-textarea"
            placeholder="è«‹è¼¸å…¥æ¨™æº–æ–‡æœ¬ä½œç‚ºè©•ä¼°åŸºæº–&#10;ç¯„ä¾‹ï¼šä»Šå¤©å¤©æ°£çœŸå¥½ï¼Œé©åˆå‡ºå»èµ°èµ°ã€‚"
            oninput="updateReferenceText()"
          ></textarea>
          <div class="reference-hint">
            è«‹è¼¸å…¥æ‚¨å¸Œæœ›ç”¨ä¾†æ¯”å°çš„æ¨™æº–æ–‡æœ¬ï¼Œç³»çµ±å°‡åˆ†æèªéŸ³è½‰éŒ„çš„æº–ç¢ºæ€§
          </div>
        </div>

        <!-- è™•ç†æ­¥é©Ÿ -->
        <div class="process-steps">
          <div class="step waiting" id="step1">
            <div class="step-left">
              <div class="step-icon">ğŸ“</div>
              <div class="step-text" id="step1Text">æº–å‚™è¼¸å…¥</div>
            </div>
            <div class="step-status waiting" id="step1Status">ç­‰å¾…ä¸­</div>
          </div>

          <div class="step waiting" id="step2">
            <div class="step-left">
              <div class="step-icon">ğŸ™ï¸</div>
              <div class="step-text">èªéŸ³è½‰æ–‡å­—</div>
            </div>
            <div class="step-status waiting" id="step2Status">ç­‰å¾…ä¸­</div>
          </div>

          <div class="step waiting" id="step3">
            <div class="step-left">
              <div class="step-icon">ğŸ§ </div>
              <div class="step-text">æº–ç¢ºæ€§åˆ†æ</div>
            </div>
            <div class="step-status waiting" id="step3Status">ç­‰å¾…ä¸­</div>
          </div>

          <div class="step waiting" id="step4">
            <div class="step-left">
              <div class="step-icon">ğŸ“Š</div>
              <div class="step-text">è©•ä¼°å ±å‘Š</div>
            </div>
            <div class="step-status waiting" id="step4Status">ç­‰å¾…ä¸­</div>
          </div>
        </div>

        <!-- è©•ä¼°çµæœé¡¯ç¤º -->
        <div class="evaluation-result" id="evaluationResult">
          <!-- è©•ä¼°ç­‰ç´šé¡¯ç¤º -->
          <div class="accuracy-level" id="accuracyLevel" style="display: none">
            <div class="accuracy-level-title">è©•ä¼°ç­‰ç´š</div>
            <div class="accuracy-level-value" id="accuracyLevelValue">--</div>
          </div>

          <div class="metric-grid">
            <div class="metric-item">
              <div class="metric-value" id="accuracyScore">--</div>
              <div class="metric-label">æº–ç¢ºç‡ (%)</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="similarityScore">--</div>
              <div class="metric-label">èªæ„ç›¸ä¼¼åº¦ (%)</div>
            </div>
          </div>

          <div class="error-analysis">
            <div class="error-analysis-title">éŒ¯èª¤åˆ†æçµ±è¨ˆ</div>
            <div class="error-types">
              <div class="error-type">
                <span class="error-type-count" id="substitutions">0</span>
                <span class="error-type-label">æ›¿æ›éŒ¯èª¤</span>
              </div>
              <div class="error-type">
                <span class="error-type-count" id="deletions">0</span>
                <span class="error-type-label">åˆªé™¤éŒ¯èª¤</span>
              </div>
              <div class="error-type">
                <span class="error-type-count" id="insertions">0</span>
                <span class="error-type-label">æ’å…¥éŒ¯èª¤</span>
              </div>
            </div>
          </div>

          <div class="suggestions-section" id="suggestionsSection">
            <div class="suggestions-title">æ”¹é€²å»ºè­°</div>
            <ul class="suggestions-list" id="suggestionsList">
              <li>ç­‰å¾…åˆ†æçµæœ...</li>
            </ul>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <button
          class="action-btn"
          id="actionBtn"
          onclick="startEvaluation()"
          disabled
        >
          <span id="btnText">è«‹å…ˆè¼¸å…¥æ¨™æº–æ–‡æœ¬å’Œé¸æ“‡éŸ³é »</span>
          <div class="loading hidden" id="btnLoading">
            <div class="spinner"></div>
            è©•ä¼°ä¸­...
          </div>
        </button>

        <!-- æ–°å¢çš„é‡è¨­æŒ‰éˆ• -->
        <button
          class="action-btn hidden"
          id="resetBtn"
          onclick="resetEvaluation()"
        >
          <span id="resetBtnText">é€²è¡Œæ–°è©•ä¼°</span>
        </button>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="error-message hidden"></div>
      </div>
    </div>

    <!-- è½‰éŒ„çµæœå½ˆçª— -->
    <div id="transcriptionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>èªéŸ³è½‰éŒ„çµæœ</h3>
          <span class="close" onclick="closeTranscriptionModal()">&times;</span>
        </div>
        <div class="modal-content-text" id="transcriptionText">
          ç­‰å¾…è½‰éŒ„çµæœ...
        </div>
      </div>
    </div>

    <!-- åˆ†æè©³æƒ…å½ˆçª— -->
    <div id="analysisModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>è©³ç´°åˆ†æçµæœ</h3>
          <span class="close" onclick="closeAnalysisModal()">&times;</span>
        </div>
        <div class="modal-content-text" id="analysisText">ç­‰å¾…åˆ†æçµæœ...</div>
      </div>
    </div>

    <!-- å ±å‘Šé è¦½å½ˆçª— -->
    <div id="reportModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>è©•ä¼°å ±å‘Šé è¦½</h3>
          <span class="close" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="modal-content-text" id="reportText">è¼‰å…¥å ±å‘Šä¸­...</div>
      </div>
    </div>

    <script>
      // ç‹€æ…‹è®Šæ•¸
      let selectedFile = null;
      let referenceText = "";
      let transcriptionResult = "";
      let evaluationResult = null;
      let isRecording = false;
      let recordingTimer = null;
      let recordingStartTime = null;
      let currentInputMode = "upload";
      let isProcessing = false;

      // DOM å…ƒç´ å¿«å–ï¼Œæå‡æ•ˆèƒ½
      const dom = {
        modeButtons: document.querySelectorAll(".mode-button"),
        uploadContent: document.getElementById("uploadContent"),
        recordingContent: document.getElementById("recordingContent"),
        fileSelected: document.getElementById("fileSelected"),
        step1Text: document.getElementById("step1Text"),
        recordButton: document.getElementById("recordButton"),
        recordingHint: document.getElementById("recordingHint"),
        inputSection: document.getElementById("inputSection"),
        recordingTimer: document.getElementById("recordingTimer"),
        audioFile: document.getElementById("audioFile"),
        fileName: document.getElementById("fileName"),
        fileSize: document.getElementById("fileSize"),
        referenceText: document.getElementById("referenceText"),
        referenceSection: document.getElementById("referenceSection"),
        actionBtn: document.getElementById("actionBtn"),
        btnText: document.getElementById("btnText"),
        btnLoading: document.getElementById("btnLoading"),
        resetBtn: document.getElementById("resetBtn"),
        errorMessage: document.getElementById("errorMessage"),
        evaluationResult: document.getElementById("evaluationResult"),
        accuracyLevel: document.getElementById("accuracyLevel"),
        accuracyLevelValue: document.getElementById("accuracyLevelValue"),
        accuracyScore: document.getElementById("accuracyScore"),
        similarityScore: document.getElementById("similarityScore"),
        substitutions: document.getElementById("substitutions"),
        deletions: document.getElementById("deletions"),
        insertions: document.getElementById("insertions"),
        suggestionsList: document.getElementById("suggestionsList"),
        transcriptionModal: document.getElementById("transcriptionModal"),
        transcriptionText: document.getElementById("transcriptionText"),
        analysisModal: document.getElementById("analysisModal"),
        analysisText: document.getElementById("analysisText"),
        reportModal: document.getElementById("reportModal"),
        reportText: document.getElementById("reportText"),
        particles: document.getElementById("particles"),
      };

      // --- åˆå§‹åŒ–å‡½å¼ ---
      function initParticles() {
        const particleCount = 12;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = `${Math.random() * 100}%`;
          const size = Math.random() * 3 + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.animationDelay = `${Math.random() * 15}s`;
          particle.style.animationDuration = `${Math.random() * 10 + 12}s`;
          dom.particles.appendChild(particle);
        }
      }

      // --- UI åˆ‡æ›èˆ‡ç‹€æ…‹æ›´æ–°å‡½å¼ ---
      function updateReferenceText() {
        referenceText = dom.referenceText.value.trim();
        dom.referenceSection.classList.toggle("ready", !!referenceText);
        updateActionButton();
      }

      function switchToUpload() {
        if (isProcessing) return;
        currentInputMode = "upload";
        dom.modeButtons[0].classList.add("active");
        dom.modeButtons[1].classList.remove("active");
        dom.uploadContent.classList.add("active");
        dom.recordingContent.classList.remove("active");
        dom.fileSelected.classList.remove("active");
        dom.step1Text.textContent = "æª”æ¡ˆæº–å‚™";
        resetEvaluation();
      }

      function switchToRecording() {
        if (isProcessing) return;
        currentInputMode = "recording";
        dom.modeButtons[0].classList.remove("active");
        dom.modeButtons[1].classList.add("active");
        dom.uploadContent.classList.remove("active");
        dom.fileSelected.classList.remove("active");
        dom.recordingContent.classList.add("active");
        dom.step1Text.textContent = "éŒ„éŸ³æº–å‚™";
        resetEvaluation();
      }

      // --- éŒ„éŸ³ç›¸é—œå‡½å¼ ---
      async function toggleRecording() {
        if (isProcessing) return;
        await (isRecording ? stopRecording() : startRecording());
      }

      async function startRecording() {
        try {
          const response = await fetch("/recording/start", { method: "POST" });
          if (!response.ok)
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
          const data = await response.json();

          if (data.success) {
            isRecording = true;
            recordingStartTime = Date.now();
            dom.recordButton.classList.add("recording");
            dom.recordButton.textContent = "â¹ï¸";
            dom.recordingHint.textContent = "é»æ“Šåœæ­¢éŒ„éŸ³";
            dom.inputSection.className = "input-section active";
            startRecordingTimer();
            updateStep("step1", "processing", "éŒ„éŸ³ä¸­");
            updateActionButton();
          } else {
            showError(`ç„¡æ³•é–‹å§‹éŒ„éŸ³ï¼š${data.error || "æœªçŸ¥éŒ¯èª¤"}`);
          }
        } catch (error) {
          showError(`éŒ„éŸ³é–‹å§‹å¤±æ•—ï¼š${error.message}`);
        }
      }

      async function stopRecording() {
        if (!referenceText) {
          showError("è«‹å…ˆè¼¸å…¥æ¨™æº–åƒè€ƒæ–‡æœ¬æ‰èƒ½é€²è¡Œè©•ä¼°");
          return;
        }

        isProcessing = true;
        if (recordingTimer) clearInterval(recordingTimer);
        recordingTimer = null;
        dom.inputSection.className = "input-section processing";
        updateStep("step1", "completed", "éŒ„éŸ³å®Œæˆ");
        updateStep("step2", "processing", "è½‰éŒ„ä¸­...");
        updateStep("step3", "processing", "åˆ†æä¸­...");
        updateStep("step4", "processing", "ç”Ÿæˆå ±å‘Š...");
        updateActionButton();

        try {
          const response = await fetch("/recording/stop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reference_text: referenceText }),
          });

          if (!response.ok)
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
          const data = await response.json();

          if (data.success) {
            dom.inputSection.className = "input-section completed";
            evaluationResult = data;
            await handleEvaluationResult(data);
          } else {
            throw new Error(data.error || "éŒ„éŸ³è™•ç†å¤±æ•—");
          }
        } catch (error) {
          showError(`éŒ„éŸ³è™•ç†å¤±æ•—ï¼š${error.message}`);
          resetStepsAfter(1);
        } finally {
          isProcessing = false;
          if (evaluationResult || dom.errorMessage.textContent) {
            dom.actionBtn.classList.add("hidden");
            dom.resetBtn.classList.remove("hidden");
          } else {
            updateActionButton();
          }
          resetRecordingState();
        }
      }

      function resetRecordingState() {
        isRecording = false;
        dom.recordButton.classList.remove("recording");
        dom.recordButton.textContent = "â—";
        dom.recordingTimer.textContent = "00:00";
        dom.recordingHint.textContent = "é»æ“Šé–‹å§‹éŒ„éŸ³";
        if (recordingTimer) clearInterval(recordingTimer);
        recordingTimer = null;
      }

      function startRecordingTimer() {
        recordingTimer = setInterval(() => {
          if (recordingStartTime) {
            const elapsed = Math.floor(
              (Date.now() - recordingStartTime) / 1000
            );
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            dom.recordingTimer.textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          }
        }, 1000);
      }

      // --- æª”æ¡ˆè™•ç†å‡½å¼ ---
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) handleFile(file);
      }

      function handleFile(file) {
        selectedFile = file;
        dom.fileName.textContent = file.name;
        dom.fileSize.textContent = formatFileSize(file.size);
        dom.uploadContent.classList.remove("active");
        dom.fileSelected.classList.add("active");
        dom.inputSection.className = "input-section ready";
        updateStep("step1", "ready", "æª”æ¡ˆå·²é¸");
        resetStepsAfter(1);
        hideError();
        updateActionButton();
      }

      function removeFile() {
        selectedFile = null;
        dom.uploadContent.classList.add("active");
        dom.fileSelected.classList.remove("active");
        dom.inputSection.className = "input-section";
        dom.audioFile.value = "";
        updateStep("step1", "waiting", "ç­‰å¾…ä¸­");
        resetStepsAfter(1);
        updateActionButton();
        hideEvaluationResult();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
      }

      // --- æ ¸å¿ƒæµç¨‹èˆ‡ UI æ›´æ–° ---
      function updateStep(stepId, status, text) {
        const step = document.getElementById(stepId);
        const statusEl = document.getElementById(`${stepId}Status`);
        step.className = `step ${status}`;
        statusEl.className = `step-status ${status}`;
        statusEl.textContent = text;
        statusEl.onclick = null; // é‡è¨­é»æ“Šäº‹ä»¶

        if (status === "completed") {
          statusEl.classList.add("clickable");
          if (stepId === "step2") statusEl.onclick = () => showTranscription();
          else if (stepId === "step3")
            statusEl.onclick = () => showAnalysisDetails();
          else if (stepId === "step4")
            statusEl.onclick = () => showReportPreview();
        }
      }

      function updateActionButton() {
        const btnText = dom.btnText;
        const btnLoading = dom.btnLoading;
        const btn = dom.actionBtn;

        if (isProcessing) {
          btn.disabled = true;
          btn.classList.add("processing");
          btnText.classList.add("hidden");
          btnLoading.classList.remove("hidden");
          return;
        }

        btnText.classList.remove("hidden");
        btnLoading.classList.add("hidden");
        btn.classList.remove("processing");

        if (!referenceText) {
          btn.disabled = true;
          btnText.textContent = "è«‹å…ˆè¼¸å…¥æ¨™æº–æ–‡æœ¬";
        } else if (currentInputMode === "upload") {
          if (selectedFile) {
            btn.disabled = false;
            btnText.textContent = "é–‹å§‹è©•ä¼°";
          } else {
            btn.disabled = true;
            btnText.textContent = "è«‹é¸æ“‡éŸ³é »æª”æ¡ˆ";
          }
        } else {
          btn.disabled = true;
          btnText.textContent = "è«‹ä½¿ç”¨éŒ„éŸ³æŒ‰éˆ•";
        }
      }

      async function startEvaluation() {
        if (!selectedFile || !referenceText || isProcessing) return;

        isProcessing = true;
        hideError();
        hideEvaluationResult();
        updateActionButton();
        dom.inputSection.className = "input-section processing";

        const formData = new FormData();
        formData.append("audio", selectedFile);
        formData.append("reference_text", referenceText);

        try {
          updateStep("step2", "processing", "è½‰éŒ„ä¸­...");
          updateStep("step3", "processing", "åˆ†æä¸­...");
          updateStep("step4", "processing", "ç”Ÿæˆå ±å‘Š...");

          const response = await fetch("/evaluation/analyze", {
            method: "POST",
            body: formData,
          });

          if (!response.ok)
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
          const data = await response.json();

          if (data.success) {
            dom.inputSection.className = "input-section completed";
            evaluationResult = data;
            await handleEvaluationResult(data);
          } else {
            throw new Error(data.error || "è©•ä¼°å¤±æ•—");
          }
        } catch (error) {
          showError(`è©•ä¼°éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
          dom.inputSection.className = "input-section ready";
          resetStepsAfter(1);
        } finally {
          isProcessing = false;
          if (evaluationResult || dom.errorMessage.textContent) {
            dom.actionBtn.classList.add("hidden");
            dom.resetBtn.classList.remove("hidden");
          } else {
            updateActionButton();
          }
        }
      }

      async function handleEvaluationResult(data) {
        if (
          !data ||
          !data.transcription ||
          !data.comparison ||
          !data.evaluation_metrics
        ) {
          showError("è©•ä¼°çµæœæ•¸æ“šä¸å®Œæ•´æˆ–æ ¼å¼éŒ¯èª¤");
          resetStepsAfter(1);
          return;
        }
        transcriptionResult = data.transcription.transcript || "ç„¡è½‰éŒ„çµæœ";
        updateStep("step2", "completed", "æŸ¥çœ‹è½‰éŒ„");
        updateStep("step3", "completed", "æŸ¥çœ‹è©³æƒ…");
        updateStep("step4", "completed", "æŸ¥çœ‹å ±å‘Š");
        showEvaluationResult(data);
      }

      function showEvaluationResult(data) {
        const metrics = data.evaluation_metrics;
        const comparison = data.comparison;

        dom.accuracyScore.textContent = (metrics.accuracy_score ?? 0).toFixed(
          1
        );
        dom.similarityScore.textContent = (
          metrics.semantic_similarity ?? 0
        ).toFixed(1);

        if (metrics.accuracy_level) {
          dom.accuracyLevelValue.textContent = metrics.accuracy_level;
          dom.accuracyLevel.style.display = "block";
        }

        const errorAnalysis = comparison.error_analysis || {};
        dom.substitutions.textContent = errorAnalysis.substitutions ?? 0;
        dom.deletions.textContent = errorAnalysis.deletions ?? 0;
        dom.insertions.textContent = errorAnalysis.insertions ?? 0;

        const suggestions = comparison.suggestions || [];
        dom.suggestionsList.innerHTML = "";
        if (suggestions.length > 0) {
          suggestions.forEach((suggestion) => {
            const li = document.createElement("li");
            li.textContent = suggestion;
            dom.suggestionsList.appendChild(li);
          });
        } else {
          dom.suggestionsList.innerHTML = "<li>æš«ç„¡ç‰¹å®šå»ºè­°</li>";
        }

        dom.evaluationResult.classList.add("show");
      }

      // --- é‡è¨­èˆ‡æ¸…ç†å‡½å¼ ---
      function resetEvaluation() {
        dom.actionBtn.classList.remove("hidden");
        dom.resetBtn.classList.add("hidden");

        selectedFile = null;
        referenceText = "";
        transcriptionResult = "";
        evaluationResult = null;
        isProcessing = false;

        dom.referenceText.value = "";
        dom.audioFile.value = "";

        dom.uploadContent.classList.toggle(
          "active",
          currentInputMode === "upload"
        );
        dom.fileSelected.classList.remove("active");
        dom.inputSection.className = "input-section";
        dom.referenceSection.classList.remove("ready");

        hideEvaluationResult();
        resetAllSteps();
        updateActionButton();
        hideError();
        resetRecordingState();
      }

      function resetStepsAfter(stepNum) {
        for (let i = stepNum + 1; i <= 4; i++) {
          updateStep(`step${i}`, "waiting", "ç­‰å¾…ä¸­");
        }
      }

      function hideEvaluationResult() {
        dom.evaluationResult.classList.remove("show");
        dom.accuracyLevel.style.display = "none";
      }

      // --- å½ˆçª— (Modal) è™•ç†å‡½å¼ ---
      function showModal(modal) {
        modal.style.display = "block";
      }

      function closeModal(modal) {
        modal.style.display = "none";
      }

      function showTranscription() {
        dom.transcriptionText.textContent =
          transcriptionResult || "æš«ç„¡è½‰éŒ„çµæœ";
        showModal(dom.transcriptionModal);
      }

      function closeTranscriptionModal() {
        closeModal(dom.transcriptionModal);
      }

      function showAnalysisDetails() {
        if (!evaluationResult || !evaluationResult.comparison) {
          dom.analysisText.textContent = "æš«ç„¡åˆ†æçµæœ";
        } else {
          const { summary, reasoning, key_differences } =
            evaluationResult.comparison;
          const analysisText = `è©•ä¼°æ‘˜è¦ï¼š\n${
            summary || "ç„¡æ‘˜è¦"
          }\n\nåˆ†æç†ç”±ï¼š\n${reasoning || "ç„¡è©³ç´°ç†ç”±"}\n\nä¸»è¦å·®ç•°ï¼š\n${
            (key_differences || []).join("\n") || "ç„¡ä¸»è¦å·®ç•°"
          }`.trim();
          dom.analysisText.textContent = analysisText;
        }
        showModal(dom.analysisModal);
      }

      function closeAnalysisModal() {
        closeModal(dom.analysisModal);
      }

      function showReportPreview() {
        if (!evaluationResult) {
          dom.reportText.textContent = "æš«ç„¡å ±å‘Šæ•¸æ“š";
        } else {
          const {
            evaluation_id,
            processing_time,
            comparison,
            evaluation_metrics,
          } = evaluationResult;

          const reportText = `è©•ä¼°IDï¼š${evaluation_id || "æœªçŸ¥"}
è™•ç†æ™‚é–“ï¼š${(processing_time || 0).toFixed(2)} ç§’

è©•ä¼°ç­‰ç´šï¼š${evaluation_metrics?.accuracy_level || "æœªè©•ç´š"}

æ•´é«”æŒ‡æ¨™ï¼š
â€¢ æº–ç¢ºç‡ï¼š${(evaluation_metrics?.accuracy_score ?? 0).toFixed(1)}%
â€¢ èªæ„ç›¸ä¼¼åº¦ï¼š${(evaluation_metrics?.semantic_similarity ?? 0).toFixed(1)}%

éŒ¯èª¤çµ±è¨ˆï¼š
â€¢ æ›¿æ›éŒ¯èª¤ï¼š${comparison?.error_analysis?.substitutions ?? 0} å€‹
â€¢ åˆªé™¤éŒ¯èª¤ï¼š${comparison?.error_analysis?.deletions ?? 0} å€‹
â€¢ æ’å…¥éŒ¯èª¤ï¼š${comparison?.error_analysis?.insertions ?? 0} å€‹

å»ºè­°ï¼š
${
  (comparison?.suggestions || []).map((s) => `â€¢ ${s}`).join("\n") ||
  "æš«ç„¡ç‰¹å®šå»ºè­°"
}`.trim();
          dom.reportText.textContent = reportText;
        }
        showModal(dom.reportModal);
      }

      function closeReportModal() {
        closeModal(dom.reportModal);
      }

      // --- éŒ¯èª¤è™•ç† ---
      function showError(message) {
        dom.errorMessage.textContent = message;
        dom.errorMessage.classList.remove("hidden");
      }

      function hideError() {
        dom.errorMessage.classList.add("hidden");
      }

      // --- å…¨åŸŸäº‹ä»¶ç›£è½ ---
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          closeModal(event.target);
        }
      };

      window.onload = function () {
        initParticles();
        checkApiStatus();
        updateActionButton();
      };

      async function checkApiStatus() {
        try {
          const response = await fetch("/status");
          if (!response.ok) throw new Error("API æœå‹™éŸ¿æ‡‰ç•°å¸¸");
          const data = await response.json();
          if (data.app_status !== "running") {
            showError("API æœå‹™æœªæ­£å¸¸é‹è¡Œï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹");
          }
        } catch (error) {
          showError(`ç„¡æ³•é€£æ¥åˆ° API æœå‹™ï¼š${error.message}`);
        }
      }
    </script>
  </body>
</html>
